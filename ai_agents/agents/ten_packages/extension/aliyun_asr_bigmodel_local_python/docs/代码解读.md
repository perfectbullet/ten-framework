以下是该文件的执行逻辑梳理与关键路径说明。

整体结构
- AliyunRecognitionCallback：承接 Dashscope 的回调，转发到扩展的 asyncio 事件循环。
- AliyunASRBigmodelExtension：异步 ASR 扩展，负责配置加载、连接管理、音频发送、结果处理、最终化与重连。

生命周期与配置
- on_init：
  - 初始化 ReconnectManager。
  - 从环境加载 AliyunASRBigmodelConfig（默认 model 为 paraformer-realtime-v2），合并 params。
  - 设置 dashscope.api_key。
  - 如有词表，调用 VocabularyService.create_vocabulary 获取 vocabulary_id。
  - 如启用 dump，创建 Dumper。
- on_deinit：停止 Dumper。

连接管理
- start_connection：
  - 校验 API key，不存在则发致命错误并返回。
  - stop_connection 确保干净重启。
  - 启动 Dumper（如有）。
  - 创建 AliyunRecognitionCallback 与 Recognition（配置所有 ASR开关、心跳、静音阈值、词表等）。
  - recognition.start() 启动流式识别。
- stop_connection：
  - recognition.stop()，置空 recognition/callback，connected=False。

回调处理
- on_open：connected=True；将当前累计的用户音频时长加入 sent_user_audio_duration_ms_before_last_reset 并重置时间轴。
- on_event：
  - 标记重连成功（若 connected）。
  - 取 sentence 字典，读取 text、begin_time、end_time；end_time 为 0 时回退到最后一个词的 end_time。
  - duration_ms = end_ms - start_ms（非负）。
  - 计算实际起始时间：audio_timeline.get_audio_duration_before_time(begin_time) + sent_user_audio_duration_ms_before_last_reset，实现将厂商相对时间映射到全局时间线。
  - 发送 ASRResult；若 final，触发 _finalize_end（报告 finalize-end 并清零计时戳）。
- on_error：记录并发送非致命错误（包含厂商码与信息）。
- on_complete：日志记录。
- on_close：connected=False；若未停止，触发重连。

音频发送与时间轴
- send_audio(frame):
  - frame.lock_buf() → bytes(audio)。
  - 如启用 dump，将字节推送到 Dumper。
  - 更新时间轴：假定 16-bit PCM 单声道，每毫秒样本数为 sample_rate/1000，字节数换算为时长：len(bytes) / (sample_rate/1000 * 2)。
  - recognition.send_audio_frame(audio_data) 发送。
  - 解锁缓冲并返回 True；异常时记录错误并返回 False。

最终化逻辑
- finalize(session_id):
  - 记录 last_finalize_timestamp（用于计算从 finalize 到最终句的延迟）。
  - 两种模式：
    - disconnect：_handle_finalize_disconnect → 若已连接则 recognition.stop()。
    - mute_pkg：_handle_finalize_mute_pkg → 按配置时长生成静音 PCM（全 0），发送并把静音计入时间轴。
- _finalize_end：当收到 final 句时，计算延迟并调用 send_asr_finalize_end()。

重连机制
- _handle_reconnect：
  - 先检查 can_retry，不可重试则发致命错误。
  - 调用 ReconnectManager.handle_reconnect(start_connection, send_asr_error) 发起重连，并记录状态。
  - on_event 时标记连接成功。

辅助方法
- vendor() 返回 aliyun_bigmodel。
- buffer_strategy() 返回 ASRBufferConfigModeDiscard（在压力下丢弃）。
- input_audio_sample_rate() 返回配置的采样率。
- is_connected() 同时要求 connected=True 且 recognition 非空。

典型执行顺序示例
1) on_init → 加载配置与资源。
2) start_connection → 构建 Recognition 并 start()。
3) send_audio → 持续推送音频，更新时间轴。
4) 回调 on_event/on_error/on_close 等 → 产生结果、处理错误、自动重连。
5) finalize → 根据模式断开或发送静音；在 final 句时完成 finalize-end。
6) stop_connection → 清理连接与状态。

注意点与潜在问题
- 异常解锁风险：send_audio 的异常分支中 frame.unlock_buf(buf) 可能在 lock_buf 失败时未定义，建议使用 try/finally 或先将 buf 初始化为 None 并判空解锁。
- 词级信息：ASRResult.words 固定为空；如需词级时间戳，应从 sentence["words"] 映射填充。
- 重连成功标记时机：当前在 on_event 中标记，通常也可在 on_open 时标记更及时。
- 声道假设：时间计算按 16-bit 单声道（2 字节/样本）；若音频为立体声需改为 4 字节/样本。
- 回调事件循环：AliyunRecognitionCallback 使用 asyncio.get_event_loop 保存 loop 并用 run_coroutine_threadsafe 提交任务，确保该 loop 是主线程正在运行的事件循环。若在不同线程初始化需确保一致。
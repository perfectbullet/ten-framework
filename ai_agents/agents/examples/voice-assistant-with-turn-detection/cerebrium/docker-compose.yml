version: '3.8'

services:
  turn-detection:
    build:
      context: .
      dockerfile: Dockerfile
    image: ten-turn-detection:latest
    container_name: ten-turn-detection-service
    restart: unless-stopped
    
    # GPU 配置
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
        limits:
          cpus: '2.0'
          memory: 14G
    
    # 端口映射
    ports:
      - "50010:50010"
    
    # 环境变量
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - MODEL_ID=TEN-framework/TEN_Turn_Detection
      - GPU_MEMORY_UTILIZATION=0.9
      - LOG_LEVEL=INFO
    
    # 卷挂载
    volumes:
      # 日志目录
      - ./logs:/app/logs
      # Hugging Face 缓存（避免重复下载模型）
      - ~/.cache/huggingface:/root/.cache/huggingface
      # 配置文件（可选，用于热更新）
      - ./cerebrium.toml:/app/cerebrium.toml:ro
    
    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:50010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    
    # 网络配置
    networks:
      - ten-network

networks:
  ten-network:
    driver: bridge